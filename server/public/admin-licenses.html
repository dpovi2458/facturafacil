<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ”‘ Admin Licencias - FacturaFÃ¡cil</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .copy-btn:active { transform: scale(0.95); }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
  <div class="max-w-4xl mx-auto p-6">
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold mb-2">ğŸ”‘ Panel de Licencias</h1>
      <p class="text-gray-400">Genera y gestiona licencias para tus clientes</p>
    </div>

    <!-- Login -->
    <div id="loginSection" class="bg-gray-800 rounded-2xl p-8 max-w-md mx-auto mb-8">
      <h2 class="text-xl font-bold mb-4">Acceso Admin</h2>
      <input 
        type="password" 
        id="adminKey" 
        placeholder="ContraseÃ±a de admin"
        class="w-full px-4 py-3 bg-gray-700 rounded-xl mb-4 focus:ring-2 focus:ring-blue-500 outline-none"
      >
      <button 
        onclick="login()"
        class="w-full py-3 bg-blue-600 hover:bg-blue-700 rounded-xl font-bold transition-colors"
      >
        Entrar
      </button>
    </div>

    <!-- Panel Principal (oculto hasta login) -->
    <div id="mainPanel" class="hidden space-y-8">
      <!-- Crear Licencias -->
      <div class="bg-gray-800 rounded-2xl p-6">
        <h2 class="text-xl font-bold mb-4">â• Crear Nueva Licencia</h2>
        <div class="grid md:grid-cols-3 gap-4 mb-4">
          <div>
            <label class="block text-gray-400 text-sm mb-1">Plan</label>
            <select id="plan" class="w-full px-4 py-3 bg-gray-700 rounded-xl">
              <option value="basico">Plan BÃ¡sico (S/29)</option>
              <option value="negocio">Plan Negocio (S/59)</option>
            </select>
          </div>
          <div>
            <label class="block text-gray-400 text-sm mb-1">DuraciÃ³n (dÃ­as)</label>
            <select id="duracion" class="w-full px-4 py-3 bg-gray-700 rounded-xl">
              <option value="30">30 dÃ­as (1 mes)</option>
              <option value="90">90 dÃ­as (3 meses)</option>
              <option value="180">180 dÃ­as (6 meses)</option>
              <option value="365">365 dÃ­as (1 aÃ±o)</option>
            </select>
          </div>
          <div>
            <label class="block text-gray-400 text-sm mb-1">Cantidad</label>
            <input 
              type="number" 
              id="cantidad" 
              value="1" 
              min="1" 
              max="50"
              class="w-full px-4 py-3 bg-gray-700 rounded-xl"
            >
          </div>
        </div>
        <button 
          onclick="crearLicencias()"
          id="btnCrear"
          class="w-full py-3 bg-green-600 hover:bg-green-700 rounded-xl font-bold transition-colors"
        >
          ğŸ”‘ Generar Licencias
        </button>
      </div>

      <!-- Licencias Generadas -->
      <div id="nuevasLicencias" class="hidden bg-gradient-to-br from-green-600 to-green-800 rounded-2xl p-6">
        <h3 class="text-xl font-bold mb-4">âœ… Licencias Generadas</h3>
        <div id="licenciasNuevas" class="space-y-2"></div>
      </div>

      <!-- Lista de Licencias -->
      <div class="bg-gray-800 rounded-2xl p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold">ğŸ“‹ Todas las Licencias</h2>
          <div class="flex gap-2">
            <button onclick="cargarLicencias('false')" class="px-3 py-1 bg-yellow-600 rounded-lg text-sm">Disponibles</button>
            <button onclick="cargarLicencias('true')" class="px-3 py-1 bg-gray-600 rounded-lg text-sm">Usadas</button>
            <button onclick="cargarLicencias()" class="px-3 py-1 bg-blue-600 rounded-lg text-sm">Todas</button>
          </div>
        </div>
        <div id="listaLicencias" class="space-y-2">
          <p class="text-gray-500 text-center py-4">Cargando...</p>
        </div>
      </div>

      <!-- Instrucciones WhatsApp -->
      <div class="bg-gray-800 rounded-2xl p-6">
        <h2 class="text-xl font-bold mb-4">ğŸ“± Mensaje para WhatsApp</h2>
        <p class="text-gray-400 text-sm mb-3">Copia y pega este mensaje cuando envÃ­es una licencia:</p>
        <div class="bg-gray-700 rounded-xl p-4">
          <pre id="mensajeWhatsApp" class="text-sm whitespace-pre-wrap">Â¡Hola! ğŸ‰

AquÃ­ estÃ¡ tu licencia de FacturaFÃ¡cil:

ğŸ”‘ CÃ³digo: XXXX-XXXX-XXXX-XXXX
ğŸ“¦ Plan: Plan Negocio
â±ï¸ DuraciÃ³n: 30 dÃ­as

Para activarla:
1. Inicia sesiÃ³n en facturafacil.pe
2. Ve a "Pagos" en el menÃº
3. Ingresa el cÃ³digo y presiona "Activar"

Â¡Gracias por tu compra! ğŸ™</pre>
        </div>
        <button 
          onclick="copiarMensaje()"
          class="mt-3 px-4 py-2 bg-green-600 hover:bg-green-700 rounded-xl text-sm transition-colors"
        >
          ğŸ“‹ Copiar mensaje
        </button>
      </div>
    </div>
  </div>

  <script>
    let adminKey = localStorage.getItem('adminKey') || '';
    const API_URL = window.location.origin + '/api/licenses';

    // Auto-login si hay clave guardada
    if (adminKey) {
      verificarAcceso();
    }

    async function login() {
      adminKey = document.getElementById('adminKey').value;
      await verificarAcceso();
    }

    async function verificarAcceso() {
      try {
        const res = await fetch(`${API_URL}/admin/list?usado=false`, {
          headers: { 'X-Admin-Key': adminKey }
        });
        
        if (res.ok) {
          localStorage.setItem('adminKey', adminKey);
          document.getElementById('loginSection').classList.add('hidden');
          document.getElementById('mainPanel').classList.remove('hidden');
          cargarLicencias('false');
        } else {
          alert('ContraseÃ±a incorrecta');
          localStorage.removeItem('adminKey');
        }
      } catch (e) {
        alert('Error de conexiÃ³n');
      }
    }

    async function crearLicencias() {
      const plan = document.getElementById('plan').value;
      const duracion_dias = parseInt(document.getElementById('duracion').value);
      const cantidad = parseInt(document.getElementById('cantidad').value);

      const btn = document.getElementById('btnCrear');
      btn.textContent = 'Generando...';
      btn.disabled = true;

      try {
        const res = await fetch(`${API_URL}/admin/create`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Key': adminKey
          },
          body: JSON.stringify({ plan, duracion_dias, cantidad })
        });

        const data = await res.json();

        if (res.ok) {
          mostrarNuevasLicencias(data.licenses);
          cargarLicencias('false');
        } else {
          alert(data.error || 'Error al crear licencias');
        }
      } catch (e) {
        alert('Error de conexiÃ³n');
      } finally {
        btn.textContent = 'ğŸ”‘ Generar Licencias';
        btn.disabled = false;
      }
    }

    function mostrarNuevasLicencias(licenses) {
      const container = document.getElementById('licenciasNuevas');
      const section = document.getElementById('nuevasLicencias');
      
      container.innerHTML = licenses.map(l => `
        <div class="bg-white/10 rounded-xl p-3 flex items-center justify-between">
          <div>
            <span class="font-mono text-lg">${l.codigo}</span>
            <span class="ml-2 text-sm opacity-70">${l.plan} â€¢ ${l.duracion_dias} dÃ­as</span>
          </div>
          <button 
            onclick="copiarCodigo('${l.codigo}', '${l.plan}', ${l.duracion_dias})" 
            class="copy-btn px-3 py-1 bg-white/20 hover:bg-white/30 rounded-lg text-sm transition-colors"
          >
            ğŸ“‹ Copiar
          </button>
        </div>
      `).join('');
      
      section.classList.remove('hidden');
    }

    async function cargarLicencias(usado = '') {
      const url = usado ? `${API_URL}/admin/list?usado=${usado}` : `${API_URL}/admin/list`;
      
      try {
        const res = await fetch(url, {
          headers: { 'X-Admin-Key': adminKey }
        });
        const data = await res.json();
        
        const container = document.getElementById('listaLicencias');
        
        if (data.licenses.length === 0) {
          container.innerHTML = '<p class="text-gray-500 text-center py-4">No hay licencias</p>';
          return;
        }
        
        container.innerHTML = data.licenses.map(l => `
          <div class="bg-gray-700 rounded-xl p-3 flex items-center justify-between ${l.usado ? 'opacity-50' : ''}">
            <div class="flex items-center gap-3">
              <span class="${l.usado ? 'line-through' : ''} font-mono">${l.codigo}</span>
              <span class="px-2 py-0.5 rounded-full text-xs ${l.plan === 'negocio' ? 'bg-purple-600' : 'bg-green-600'}">${l.plan}</span>
              <span class="text-gray-400 text-sm">${l.duracion_dias}d</span>
            </div>
            <div class="flex items-center gap-2">
              ${l.usado 
                ? `<span class="text-gray-400 text-xs">Usado: ${new Date(l.fecha_uso).toLocaleDateString('es-PE')}</span>` 
                : `<button onclick="copiarCodigo('${l.codigo}', '${l.plan}', ${l.duracion_dias})" class="copy-btn px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded-lg text-xs transition-colors">ğŸ“‹</button>`
              }
            </div>
          </div>
        `).join('');
      } catch (e) {
        document.getElementById('listaLicencias').innerHTML = '<p class="text-red-500 text-center py-4">Error al cargar</p>';
      }
    }

    function copiarCodigo(codigo, plan, dias) {
      const planNombre = plan === 'negocio' ? 'Plan Negocio' : 'Plan BÃ¡sico';
      const mensaje = `Â¡Hola! ğŸ‰

AquÃ­ estÃ¡ tu licencia de FacturaFÃ¡cil:

ğŸ”‘ CÃ³digo: ${codigo}
ğŸ“¦ Plan: ${planNombre}
â±ï¸ DuraciÃ³n: ${dias} dÃ­as

Para activarla:
1. Inicia sesiÃ³n en facturafacil.pe
2. Ve a "Pagos" en el menÃº
3. Ingresa el cÃ³digo y presiona "Activar"

Â¡Gracias por tu compra! ğŸ™`;

      navigator.clipboard.writeText(mensaje);
      alert(`âœ… CÃ³digo copiado con mensaje completo!\n\n${codigo}`);
    }

    function copiarMensaje() {
      const mensaje = document.getElementById('mensajeWhatsApp').textContent;
      navigator.clipboard.writeText(mensaje);
      alert('Mensaje copiado!');
    }
  </script>
</body>
</html>
